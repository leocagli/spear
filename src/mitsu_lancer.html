<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spear | Freelance Web3 con Escrow</title>
    <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-600">Spear</h1>
                <div class="flex items-center space-x-4">
                    <span id="networkStatus" class="text-sm text-gray-500"></span>
                    <button id="connectWallet" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Conectar Wallet
                    </button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto px-4 py-8">
            <section class="text-center py-16 bg-white rounded-xl shadow-lg mb-8">
                <h2 class="text-4xl font-bold text-gray-900 mb-4">
                    Freelance Web3 con Smart Contracts
                </h2>
                <p class="text-lg text-gray-600 mb-8">
                    Plataforma descentralizada con escrow seguro y milestones
                </p>
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                    ✅ Contrato deployado en Sepolia: 0x9979F6a5cE685Fca312f933Cf942C19faBF7e96d
                </div>
            </section>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">Crear Proyecto</h3>
                    <form id="projectForm">
                        <input type="text" id="description" placeholder="Descripción del proyecto" 
                               class="w-full p-2 border rounded mb-4" required>
                        <input type="text" id="milestones" placeholder="Milestones en ETH (ej: 0.1,0.2,0.3)" 
                               class="w-full p-2 border rounded mb-4" required>
                        <input type="number" id="riskFund" placeholder="Fondo de riesgo (ETH)" step="0.01"
                               class="w-full p-2 border rounded mb-4" value="0">
                        <select id="protection" class="w-full p-2 border rounded mb-4">
                            <option value="0">Protección Básica (0% comisión)</option>
                            <option value="1">Protección Premium (1-3% comisión)</option>
                        </select>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                            Crear Proyecto
                        </button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">Mis Proyectos</h3>
                    <div id="projectList" class="space-y-4">
                        <p class="text-gray-500">Conecta tu wallet para ver proyectos</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
                <h3 class="text-lg font-bold text-blue-800 mb-2">Características de Spear</h3>
                <ul class="text-blue-700 space-y-1">
                    <li>✅ 0% comisiones (1-3% con protección premium)</li>
                    <li>✅ Pagos por milestones completados</li>
                    <li>✅ Fondos de riesgo opcionales</li>
                    <li>✅ Máximo 5 proyectos activos por desarrollador</li>
                    <li>✅ Proyectos expiran en 7 días si no se asignan</li>
                    <li>✅ Mínimo 10 USDT por proyecto</li>
                </ul>
            </div>
        </main>
    </div>

    <script>
        let provider, signer, contract, userAddress;
        
        // Contrato deployado en Sepolia
        const CONTRACT_ADDRESS = "0x9979F6a5cE685Fca312f933Cf942C19faBF7e96d";
        const SEPOLIA_CHAIN_ID = "0xaa36a7";
        
        const CONTRACT_ABI = [
            "function createProject(string memory description, uint256[] memory milestoneAmounts, uint256 riskFund, uint8 protection) external payable",
            "function applyToProject(uint256 projectId) external",
            "function approveDeveloper(uint256 projectId, address developer) external",
            "function completeMilestone(uint256 projectId, uint256 milestone) external",
            "function projects(uint256) external view returns (address, address, uint256, uint256, uint256[], bool[], uint8, uint8, uint256, uint256, string, bool)",
            "function projectCounter() external view returns (uint256)",
            "event ProjectCreated(uint256 indexed projectId, address indexed client, uint256 amount)",
            "event DeveloperApplied(uint256 indexed projectId, address indexed developer)",
            "event MilestoneCompleted(uint256 indexed projectId, uint256 milestone)"
        ];

        // Input sanitization
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Switch to Sepolia
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: SEPOLIA_CHAIN_ID,
                                    chainName: 'Sepolia Testnet',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://sepolia.infura.io/v3/'],
                                    blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                }]
                            });
                        }
                    }
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    document.getElementById('connectWallet').textContent = 
                        `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
                    document.getElementById('networkStatus').textContent = 'Sepolia Testnet';
                    
                    loadProjects();
                } catch (error) {
                    console.error('Error conectando wallet:', error);
                    alert('Error conectando wallet: ' + error.message);
                }
            } else {
                alert('MetaMask no detectado. Instala MetaMask para usar Spear.');
            }
        }

        async function createProject(description, milestones, riskFund, protection) {
            if (!contract) {
                alert('Conecta tu wallet primero');
                return;
            }

            try {
                const milestoneAmounts = milestones.split(',').map(m => ethers.utils.parseEther(m.trim()));
                const totalAmount = milestoneAmounts.reduce((a, b) => a.add(b), ethers.BigNumber.from(0));
                const riskFundWei = ethers.utils.parseEther(riskFund || '0');
                
                console.log('Creating project with:', {
                    description: sanitizeInput(description),
                    milestoneAmounts: milestoneAmounts.map(m => ethers.utils.formatEther(m)),
                    riskFund: ethers.utils.formatEther(riskFundWei),
                    totalValue: ethers.utils.formatEther(totalAmount.add(riskFundWei))
                });
                
                const tx = await contract.createProject(
                    sanitizeInput(description),
                    milestoneAmounts,
                    riskFundWei,
                    parseInt(protection),
                    { value: totalAmount.add(riskFundWei) }
                );
                
                document.getElementById('projectList').innerHTML = '<p class="text-blue-500">Creando proyecto... Confirma la transacción</p>';
                
                await tx.wait();
                alert('¡Proyecto creado exitosamente!');
                loadProjects();
                
                // Clear form
                document.getElementById('projectForm').reset();
                
            } catch (error) {
                console.error('Error creando proyecto:', error);
                alert('Error creando proyecto: ' + (error.reason || error.message));
            }
        }

        async function loadProjects() {
            if (!contract) return;
            
            try {
                const projectCount = await contract.projectCounter();
                const projectsHtml = [];
                
                for (let i = 1; i <= projectCount; i++) {
                    try {
                        const project = await contract.projects(i);
                        const [client, developer, totalAmount, riskFund, , , protection, status] = project;
                        
                        if (client.toLowerCase() === userAddress.toLowerCase()) {
                            const statusText = ['Abierto', 'En Progreso', 'Completado', 'Cancelado', 'Expirado'][status];
                            const protectionText = protection === 0 ? 'Básica' : 'Premium';
                            
                            projectsHtml.push(`
                                <div class="border rounded p-3 bg-gray-50">
                                    <p class="font-semibold">Proyecto #${i}</p>
                                    <p class="text-sm text-gray-600">Monto: ${ethers.utils.formatEther(totalAmount)} ETH</p>
                                    <p class="text-sm text-gray-600">Estado: ${statusText}</p>
                                    <p class="text-sm text-gray-600">Protección: ${protectionText}</p>
                                    ${developer !== ethers.constants.AddressZero ? 
                                        `<p class="text-sm text-green-600">Dev: ${developer.slice(0,6)}...${developer.slice(-4)}</p>` : 
                                        '<p class="text-sm text-orange-600">Sin desarrollador asignado</p>'
                                    }
                                </div>
                            `);
                        }
                    } catch (err) {
                        console.log(`Error loading project ${i}:`, err);
                    }
                }
                
                document.getElementById('projectList').innerHTML = 
                    projectsHtml.length > 0 ? projectsHtml.join('') : '<p class="text-gray-500">No tienes proyectos creados</p>';
                    
            } catch (error) {
                console.error('Error cargando proyectos:', error);
                document.getElementById('projectList').innerHTML = '<p class="text-red-500">Error cargando proyectos</p>';
            }
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = document.getElementById('description').value;
            const milestones = document.getElementById('milestones').value;
            const riskFund = document.getElementById('riskFund').value;
            const protection = document.getElementById('protection').value;
            
            if (description && milestones) {
                await createProject(description, milestones, riskFund, protection);
            }
        });

        // Auto-connect if wallet was previously connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });
    </script>
</body>
</html>